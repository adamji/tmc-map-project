# 微信云托管集成指南

## 🌟 集成优势

使用微信云托管相比传统HTTP请求的优势：
- ✅ **不耗费公网流量**：前后端通信走内网
- ✅ **天然安全防护**：免疫DDoS攻击，仅授权小程序可访问
- ✅ **就近接入加速**：无视后端服务地域影响，无跨地域延迟
- ✅ **无需域名配置**：不需要在小程序后台配置「服务器域名」
- ✅ **直接获取用户信息**：后端可直接获取openid等用户信息

## 📋 前提条件

1. **微信小程序基础库版本** ≥ 2.23.0
2. **在小程序管理后台设置基础库最低版本** ≥ 2.23.0
3. **微信云托管环境已创建并部署服务**

## 🔧 配置说明

### 1. 云托管参数配置

在 `src/config/cloud.js` 中配置你的云托管参数：

```javascript
export const CLOUD_CONFIG = {
  // 你的微信云托管环境ID
  env: 'prod-4g2xqhcl04d0b0dc',
  
  // 你的服务名称
  serviceName: 'springboot',
  
  // 降级方案的HTTP地址
  fallbackBaseUrl: 'https://springboot-gub6-171302-5-1367566291.sh.run.tcloudbase.com'
}
```

### 2. 如何获取环境ID和服务名称

1. **环境ID**：
   - 登录微信云托管控制台
   - 在环境列表中查看「环境ID」

2. **服务名称**：
   - 进入对应环境
   - 在「服务管理」→「服务列表」中查看「服务名称」

### 3. 资源复用配置（可选）

如果你的小程序需要访问其他账号的云托管环境，需要配置：

```javascript
export const CLOUD_CONFIG = {
  env: 'prod-4g2xqhcl04d0b0dc',
  serviceName: 'springboot',
  
  // 资源复用配置
  resourceAppid: 'WXAAA', // 环境所属的账号appid
  resourceEnv: 'prod-001'  // 微信云托管的环境ID
}
```

## 🚀 使用方式

### 自动切换模式（推荐）

项目已配置自动切换机制：
- **微信小程序环境**：自动使用云托管内网调用
- **其他环境**：自动降级到传统HTTP请求

```javascript
import { clubApi } from '@/services/club.js'

// 调用方式不变，底层自动选择最优方案
const clubs = await clubApi.getClubList()
```

### 手动云托管调用

如果需要直接使用云托管调用：

```javascript
import { directCloudCall } from '@/utils/cloudRequest.js'

const result = await directCloudCall({
  url: '/api/clubs',
  method: 'GET'
})
```

## 📱 开发和调试

### 1. 开发环境

在开发环境中，代码会自动降级到本地HTTP请求：
- `http://localhost:8080` （默认）
- `http://10.153.225.219:8080` （手机调试时）

### 2. 微信开发者工具调试

1. **启用云托管**：
   - 确保项目关联了正确的小程序
   - 在「详情」→「本地设置」中启用云能力

2. **查看调用日志**：
   - 在控制台可以看到云托管调用结果
   - 包含 `callID` 用于追踪请求

### 3. 真机测试

1. **预览二维码**：生成预览二维码进行真机测试
2. **查看网络请求**：在真机上，请求会走云托管内网
3. **性能对比**：对比云托管和HTTP请求的响应时间

## 🔍 故障排除

### 1. 云托管调用失败

**常见原因**：
- 环境ID或服务名称配置错误
- 小程序未关联云托管环境
- 基础库版本过低

**解决方案**：
- 检查配置参数
- 确认小程序与云托管环境的关联关系
- 升级基础库版本

### 2. 自动降级到HTTP请求

**可能原因**：
- 不在微信小程序环境中
- 云托管初始化失败
- 网络异常

**这是正常行为**：项目设计了降级机制，确保在任何环境下都能正常工作

### 3. 获取不到用户信息

**解决方案**：
- 确保使用云托管调用（不是HTTP请求）
- 在后端通过请求头获取用户信息
- 检查小程序是否已登录

## 📊 性能监控

### 1. 请求日志

云托管调用会输出详细日志：
```
微信云托管调用结果success | callid:xxx-xxx-xxx
```

### 2. 性能对比

可以通过以下方式对比性能：
- 云托管调用延迟
- HTTP请求延迟
- 网络流量消耗

## 🔒 安全考虑

### 1. 关闭公网访问

如果服务只供小程序使用，建议在云托管控制台关闭公网访问：
- 进入「服务管理」
- 在「网络配置」中关闭「公网访问」

### 2. 用户身份验证

云托管会自动在请求头中添加用户信息：
- `openid`：用户唯一标识
- `unionid`：用户在开放平台的唯一标识
- 来源IP等信息

## 📝 最佳实践

1. **优先使用云托管**：在微信小程序中优先使用云托管调用
2. **保留降级方案**：确保在非微信环境中也能正常工作
3. **统一错误处理**：使用统一的错误处理机制
4. **监控调用情况**：定期检查云托管调用的成功率和性能
5. **合理设置超时**：根据业务需求设置合适的请求超时时间

## 🔄 迁移指南

### 从传统HTTP请求迁移：

1. **更新请求工具**：
   ```javascript
   // 旧方式
   import { request } from '@/utils/request.js'
   
   // 新方式
   import { request } from '@/utils/cloudRequest.js'
   ```

2. **更新API路径**：
   ```javascript
   // 旧方式
   url: `${API_BASE}/api/clubs`
   
   // 新方式
   url: getApiPath('/api/clubs')
   ```

3. **测试验证**：
   - 在微信开发者工具中测试
   - 生成预览二维码真机测试
   - 验证数据返回正确

## 📞 技术支持

遇到问题时，可以：
1. 查看微信开发者工具控制台日志
2. 检查云托管控制台的服务日志
3. 参考微信官方文档
4. 在项目中启用详细日志进行调试 