# äº‘æ‰˜ç®¡éƒ¨ç½²æ•…éšœæ’é™¤æŒ‡å—

## ğŸš¨ å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

### 1. Liveness/Readiness probe failed

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Liveness probe failed: dial tcp 10.22.1.205:8080: connect: connection refused
Readiness probe failed: dial tcp 10.22.1.205:8080: connect: connection refused
```

**åŸå› åˆ†æ**ï¼š
- åº”ç”¨å¯åŠ¨æ—¶é—´è¿‡é•¿ï¼Œå¥åº·æ£€æŸ¥è¶…æ—¶
- å¥åº·æ£€æŸ¥è·¯å¾„é…ç½®é”™è¯¯
- æ•°æ®åº“è¿æ¥é—®é¢˜å¯¼è‡´åº”ç”¨æ— æ³•æ­£å¸¸å¯åŠ¨
- ç«¯å£é…ç½®ä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**ï¼š

#### æ–¹æ¡ˆ1ï¼šä¿®æ”¹å¥åº·æ£€æŸ¥é…ç½®
```dockerfile
# å»¶é•¿å¯åŠ¨ç­‰å¾…æ—¶é—´ï¼Œå¢åŠ é‡è¯•æ¬¡æ•°
HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=3 \
  CMD curl -f http://localhost:8080/api/actuator/health || \
      curl -f http://localhost:8080/api/health || \
      curl -f http://localhost:8080/api/ || exit 1
```

#### æ–¹æ¡ˆ2ï¼šæ£€æŸ¥æ•°æ®åº“è¿æ¥
1. ç¡®è®¤æ•°æ®åº“åœ°å€ï¼š`10.22.100.35:3306`
2. ç¡®è®¤æ•°æ®åº“åç§°ï¼š`tmc_map`
3. ç¡®è®¤ç”¨æˆ·åå¯†ç ï¼š`root/Zc2fQCTX`
4. æµ‹è¯•ç½‘ç»œè¿é€šæ€§

#### æ–¹æ¡ˆ3ï¼šæ·»åŠ å¤šä¸ªå¥åº·æ£€æŸ¥ç«¯ç‚¹
- `/api/actuator/health` - Spring Boot Actuator
- `/api/health` - è‡ªå®šä¹‰å¥åº·æ£€æŸ¥
- `/api/` - æ ¹è·¯å¾„æ£€æŸ¥

### 2. æ•°æ®åº“è¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Could not create connection to database server
Communications link failure
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

#### æ£€æŸ¥æ•°æ®åº“é…ç½®
```yaml
# application-prod.yml
spring:
  datasource:
    url: jdbc:mysql://10.22.100.35:3306/tmc_map?useSSL=true&serverTimezone=Asia/Shanghai&characterEncoding=utf8&allowPublicKeyRetrieval=true
    username: root
    password: Zc2fQCTX
    hikari:
      maximum-pool-size: 10
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
```

#### ç½‘ç»œè¿é€šæ€§æµ‹è¯•
```bash
# åœ¨äº‘æ‰˜ç®¡æ§åˆ¶å°æµ‹è¯•
telnet 10.22.100.35 3306
```

### 3. åº”ç”¨å¯åŠ¨è¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**ï¼š

#### ä¼˜åŒ–JVMå‚æ•°
```dockerfile
ENV JAVA_OPTS="-Xms512m -Xmx1024m -XX:+UseG1GC -XX:+UseStringDeduplication -Djava.security.egd=file:/dev/./urandom"
```

#### å»¶é•¿å¥åº·æ£€æŸ¥ç­‰å¾…æ—¶é—´
```dockerfile
# å¯åŠ¨ç­‰å¾…æ—¶é—´ä»60så¢åŠ åˆ°120s
HEALTHCHECK --start-period=120s
```

### 4. ç«¯å£é…ç½®é—®é¢˜

**æ£€æŸ¥æ¸…å•**ï¼š
1. âœ… Dockerfile EXPOSE 8080
2. âœ… application.yml server.port: 8080
3. âœ… äº‘æ‰˜ç®¡æœåŠ¡ç«¯å£é…ç½®ä¸º8080
4. âœ… å¥åº·æ£€æŸ¥è·¯å¾„åŒ…å«context-path

## ğŸ”§ è°ƒè¯•æ­¥éª¤

### 1. æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—
1. è¿›å…¥äº‘æ‰˜ç®¡æ§åˆ¶å°
2. é€‰æ‹©å¯¹åº”æœåŠ¡å’Œç‰ˆæœ¬
3. æŸ¥çœ‹ã€Œéƒ¨ç½²æ—¥å¿—ã€
4. é‡ç‚¹å…³æ³¨å¯åŠ¨é”™è¯¯ä¿¡æ¯

### 2. æŸ¥çœ‹è¿è¡Œæ—¥å¿—
1. è¿›å…¥ã€Œæ—¥å¿—ã€é¡µé¢
2. æŸ¥çœ‹åº”ç”¨å¯åŠ¨æ—¥å¿—
3. æ£€æŸ¥æ•°æ®åº“è¿æ¥æ—¥å¿—
4. æŸ¥çœ‹å¥åº·æ£€æŸ¥è¯·æ±‚æ—¥å¿—

### 3. æœ¬åœ°æµ‹è¯•
```bash
# æœ¬åœ°å¯åŠ¨æµ‹è¯•
cd tmc-map-backend
mvn spring-boot:run -Dspring-boot.run.profiles=prod

# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:8080/api/actuator/health
curl http://localhost:8080/api/health
curl http://localhost:8080/api/
```

### 4. Dockeræœ¬åœ°æµ‹è¯•
```bash
# æ„å»ºé•œåƒ
docker build -t tmc-map-backend .

# è¿è¡Œå®¹å™¨
docker run -p 8080:8080 \
  -e SPRING_PROFILES_ACTIVE=prod \
  tmc-map-backend

# æµ‹è¯•å¥åº·æ£€æŸ¥
docker exec -it <container_id> curl http://localhost:8080/api/health
```

## ğŸš€ éƒ¨ç½²æœ€ä½³å®è·µ

### 1. åˆ†é˜¶æ®µéƒ¨ç½²
```bash
# ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€åŠŸèƒ½
- ç®€åŒ–é…ç½®
- ä½¿ç”¨H2æ•°æ®åº“æµ‹è¯•
- éªŒè¯åŸºæœ¬åŠŸèƒ½

# ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®åº“é›†æˆ
- è¿æ¥MySQLæ•°æ®åº“
- æµ‹è¯•æ•°æ®æ“ä½œ
- éªŒè¯å¥åº·æ£€æŸ¥

# ç¬¬ä¸‰é˜¶æ®µï¼šå®Œæ•´åŠŸèƒ½
- å¯ç”¨æ‰€æœ‰åŠŸèƒ½
- æ€§èƒ½ä¼˜åŒ–
- ç›‘æ§é…ç½®
```

### 2. é…ç½®ç®¡ç†
```yaml
# ä½¿ç”¨ç¯å¢ƒå˜é‡è¦†ç›–æ•æ„Ÿé…ç½®
spring:
  datasource:
    url: ${DB_URL:jdbc:mysql://10.22.100.35:3306/tmc_map}
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:Zc2fQCTX}
```

### 3. ç›‘æ§é…ç½®
```yaml
# å¯ç”¨è¯¦ç»†çš„å¥åº·æ£€æŸ¥
management:
  endpoint:
    health:
      show-details: always
  health:
    db:
      enabled: true
    diskspace:
      enabled: true
```

## ğŸ“Š æ•…éšœæ’é™¤æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰æ£€æŸ¥
- [ ] ä»£ç ç¼–è¯‘æ— é”™è¯¯
- [ ] æœ¬åœ°æµ‹è¯•é€šè¿‡
- [ ] Dockeré•œåƒæ„å»ºæˆåŠŸ
- [ ] å¥åº·æ£€æŸ¥ç«¯ç‚¹å¯è®¿é—®
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸

### éƒ¨ç½²ä¸­æ£€æŸ¥
- [ ] é•œåƒä¸Šä¼ æˆåŠŸ
- [ ] å®¹å™¨å¯åŠ¨æ­£å¸¸
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] æ—¥å¿—æ— é”™è¯¯ä¿¡æ¯
- [ ] ç«¯å£é…ç½®æ­£ç¡®

### éƒ¨ç½²åæ£€æŸ¥
- [ ] æœåŠ¡çŠ¶æ€æ­£å¸¸
- [ ] APIæ¥å£å¯è®¿é—®
- [ ] æ•°æ®åº“æ“ä½œæ­£å¸¸
- [ ] å‰ç«¯è°ƒç”¨æˆåŠŸ
- [ ] æ€§èƒ½æŒ‡æ ‡æ­£å¸¸

## ğŸ†˜ ç´§æ€¥å¤„ç†

### å¦‚æœéƒ¨ç½²å¤±è´¥
1. **ç«‹å³å›æ»š**ï¼šä½¿ç”¨ä¸Šä¸€ä¸ªå¯ç”¨ç‰ˆæœ¬
2. **ä¿å­˜æ—¥å¿—**ï¼šä¸‹è½½å¤±è´¥ç‰ˆæœ¬çš„æ—¥å¿—
3. **æœ¬åœ°å¤ç°**ï¼šåœ¨æœ¬åœ°ç¯å¢ƒå¤ç°é—®é¢˜
4. **ä¿®å¤é—®é¢˜**ï¼šæ ¹æ®æ—¥å¿—ä¿®å¤å…·ä½“é—®é¢˜
5. **é‡æ–°éƒ¨ç½²**ï¼šéªŒè¯ä¿®å¤åé‡æ–°éƒ¨ç½²

### è”ç³»æ”¯æŒ
å¦‚æœé—®é¢˜æ— æ³•è§£å†³ï¼Œè¯·æä¾›ï¼š
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- éƒ¨ç½²é…ç½®ä¿¡æ¯
- æœ¬åœ°æµ‹è¯•ç»“æœ
- é—®é¢˜å¤ç°æ­¥éª¤ 